name: Impacted Tests Based on Changes

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - test  # Replace with your feature branch name

jobs:
  impact-analysis:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code with full history to compare all branches
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history for proper comparison

      # Step 2: Ensure all remote branches are fetched
      - name: Fetch all remote branches
        run: |
          git fetch --all

      # Step 3: Get the list of modified files using git diff
      - name: Get modified files
        id: get_changed_files
        run: |
          # Fetch and ensure that we have the latest refs
          git fetch origin main
          # Use git diff to get the list of files modified between the current branch and origin/main
          PR_DIFF=$(git diff --name-only origin/main...HEAD)
          echo "Changed files: $PR_DIFF"
          
          # Save changed files to environment variable for further use
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$PR_DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Step 4: Run impacted tests based on modified files
      - name: Run impacted tests
        run: |
          if [[ "$PR_DIFF" == *"src/login.js"* ]]; then
            echo "Running login tests..."
            # Run the Cypress tests impacted by the login.js file
            npx cypress run --spec 'cypress/integration/login.cy.js'
          fi

          if [[ "$PR_DIFF" == *"src/navbar.js"* ]]; then
            echo "Running navbar tests..."
            # Run impacted tests for navbar
            npx cypress run --spec 'cypress/integration/navbar.cy.js'
          fi
