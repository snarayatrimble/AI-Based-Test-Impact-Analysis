name: Impacted Tests Based on Changes

on:
  pull_request:
    branches:
      - main
      - master 
      - test # Include master as well if you have both branches
  push:
    branches:
      - test  # Replace with your feature branch name

jobs:
  impact-analysis:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history for proper comparison

      # Step 2: Fetch the default branch dynamically
      - name: Get default branch name
        id: get_default_branch
        run: |
          # Use GitHub API to fetch the default branch
          DEFAULT_BRANCH=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}" \
            | jq -r '.default_branch')
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV

      # Step 3: Fetch the latest commits from the default branch
      - name: Fetch latest commits from the default branch
        run: |
          git fetch origin ${{ env.DEFAULT_BRANCH }}  # Dynamically fetch default branch

      # Step 4: Get modified files using git diff
      - name: Get modified files
        id: get_changed_files
        run: |
          # Use git diff to get the list of files modified between the default branch and HEAD
          PR_DIFF=$(git diff --name-only origin/${{ env.DEFAULT_BRANCH }}...HEAD)
          echo "Changed files: $PR_DIFF"

          # Save changed files to environment variable
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$PR_DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Step 5: Run impacted tests based on changed files
      - name: Run impacted tests
        run: |
          if [[ "$PR_DIFF" == *"src/login.js"* ]]; then
            echo "Running login tests..."
            # Run the Cypress tests impacted by the login.js file
            npx cypress run --spec 'cypress/integration/login.cy.js'
          fi

          if [[ "$PR_DIFF" == *"src/navbar.js"* ]]; then
            echo "Running navbar tests..."
            # Run impacted tests for navbar
            npx cypress run --spec 'cypress/integration/navbar.cy.js'
          fi
